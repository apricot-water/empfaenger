<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Oma Display V9 Hybrid</title>
<style>
    /* === OMA UI DESIGN === */
    :root { --bg: #000000; --text: #ffffff; --accent: #4cd137; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; }
    
    #metaInfo { height: 60px; width: 100%; background: #111; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: center; font-size: 2.5vh; color: #888; flex-shrink: 0; z-index: 5; }
    #displayArea { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; overflow: hidden; position: relative; }
    #messageText { font-size: 6vh; line-height: 1.2; font-weight: bold; word-wrap: break-word; max-height: 100%; overflow-y: auto; width: 100%; }
    #messageImg { max-width: 100%; max-height: 65vh; object-fit: contain; border-radius: 20px; margin-bottom: 20px; display: none; }
    
    .nav-zone { position: fixed; top: 60px; bottom: 0; width: 20%; z-index: 10; opacity: 0; display: flex; align-items: center; justify-content: center; font-size: 50px; color: white; background: rgba(255,255,255,0.1); cursor: pointer; }
    .nav-zone:active { opacity: 1; }
    #btnPrev { left: 0; } #btnNext { right: 0; }

    /* SETUP SCREEN */
    #setupScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; overflow-y: auto; padding: 20px; }
    input { padding: 12px; font-size: 18px; border-radius: 8px; border: none; width: 90%; max-width: 400px; text-align: center; }
    .group-label { color: #888; font-size: 14px; margin-top: 10px; width: 90%; max-width: 400px; text-align: left; }
    button { padding: 15px 30px; font-size: 20px; background: var(--accent); border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px;}

    /* TOOLS */
    #statusLight { position: fixed; top: 10px; right: 10px; width: 15px; height: 15px; border-radius: 50%; background: orange; z-index: 50; border: 2px solid white; cursor: pointer; }
    #reloadBtn { position: fixed; bottom: 15px; right: 15px; width: 40px; height: 40px; background: rgba(50,50,50,0.8); border: 1px solid #666; border-radius: 50%; color: #ccc; font-size: 20px; display: flex; align-items: center; justify-content: center; z-index: 40; cursor: pointer; }
    #debugLog { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; background: rgba(0,0,0,0.8); color: lime; font-family: monospace; font-size: 10px; overflow-y: scroll; pointer-events: none; z-index: 40; padding: 5px; box-sizing: border-box; display: none; }
</style>
</head>
<body>

    <div id="statusLight" onclick="toggleDebug()"></div>
    <div id="debugLog"></div>
    <div id="reloadBtn" onclick="location.reload()">↻</div>

    <div id="setupScreen">
        <h1 style="color:white; margin:0">Einrichtung</h1>
        <div style="color:#aaa; font-size:12px; margin-bottom:10px">Oder Magic-Link benutzen</div>
        
        <div class="group-label">GitHub Archiv</div>
        <input id="ghUser" placeholder="User">
        <input id="ghRepo" placeholder="Repo">
        <input id="ghToken" type="password" placeholder="Token">

        <div class="group-label">NTFY (Live)</div>
        <input id="setupTopic" placeholder="Topic">
        <input id="setupPass" type="password" placeholder="Passwort">
        
        <button onclick="saveSetup()">Starten</button>
        <button onclick="resetApp()" style="background:#555; font-size:14px; margin-top:0">Reset</button>
    </div>

    <div id="metaInfo"></div>
    <div id="displayArea">
        <img id="messageImg" src="">
        <div id="messageText">Lade Archiv...</div>
    </div>
    <div id="btnPrev" class="nav-zone" onclick="prevMsg()">❮</div>
    <div id="btnNext" class="nav-zone" onclick="nextMsg()">❯</div>

<script>
    // === 0. MAGIC LINK CHECK (Muss ganz oben sein) ===
    (function checkMagicLink() {
        const hash = window.location.hash;
        if (hash.startsWith('#config=')) {
            try {
                // Decodieren
                const b64 = hash.substring(8);
                const json = JSON.parse(atob(b64));
                
                // Mapping der Short-Keys (Sender) auf Config-Keys (Empfänger)
                // t=Topic, p=Pass, gu=GitUser, gr=GitRepo, gt=GitToken
                const newConf = {
                    ghUser: json.gu,
                    ghRepo: json.gr,
                    ghToken: json.gt,
                    ntfyTopic: json.t,
                    pass: json.p
                };

                // Validierung
                if(newConf.ghUser && newConf.ntfyTopic && newConf.pass) {
                    localStorage.setItem('oma_conf_v9', JSON.stringify(newConf));
                    // URL sauber machen (Sicherheit)
                    history.replaceState(null, null, window.location.pathname);
                    // Reload für sauberen Start
                    location.reload();
                } else {
                    alert("Link unvollständig.");
                }
            } catch (e) {
                console.error("Link Error", e);
                alert("Konfigurations-Link fehlerhaft.");
            }
        }
    })();

    // === 1. BASIC SETUP ===
    function log(msg) { console.log(msg); const d=document.getElementById('debugLog'); if(d) d.innerHTML=`> ${msg}<br>`+d.innerHTML; }
    function toggleDebug() { const d=document.getElementById('debugLog'); d.style.display=d.style.display==='none'?'block':'none'; }

    let config = JSON.parse(localStorage.getItem('oma_conf_v9')) || null;
    let messages = []; 
    let currentIndex = 0;
    
    // Web Crypto
    const enc = new TextEncoder();
    const dec = new TextDecoder();
    async function getKey(password, salt) {
        const k = await window.crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
        return window.crypto.subtle.deriveKey({name:"PBKDF2", salt:salt, iterations:100000, hash:"SHA-256"}, k, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]);
    }
    async function decryptStr(base64Data, password) {
        try {
            if(!base64Data) return null;
            const bin = atob(base64Data);
            const bytes = new Uint8Array(bin.length);
            for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
            const salt=bytes.slice(0,16), iv=bytes.slice(16,28), data=bytes.slice(28);
            const key = await getKey(password, salt);
            const decrypted = await window.crypto.subtle.decrypt({name:"AES-GCM", iv:iv}, key, data);
            return dec.decode(decrypted);
        } catch(e) { console.error(e); return null; }
    }

    // Falls Config da ist -> Direkt start
    if(config) {
        document.getElementById('setupScreen').style.display = 'none';
        startApp();
    } else {
        // Falls manuell eingegeben werden soll (Fallback)
        // Vorbelegung falls Felder leer
    }

    function saveSetup() {
        const c = {
            ghUser: document.getElementById('ghUser').value.trim(),
            ghRepo: document.getElementById('ghRepo').value.trim(),
            ghToken: document.getElementById('ghToken').value.trim(),
            ntfyTopic: document.getElementById('setupTopic').value.trim(),
            pass: document.getElementById('setupPass').value.trim()
        };
        if(!c.ghUser || !c.ghToken || !c.ntfyTopic || !c.pass) return alert("Alles ausfüllen!");
        localStorage.setItem('oma_conf_v9', JSON.stringify(c));
        location.reload();
    }
    function resetApp() { localStorage.removeItem('oma_conf_v9'); location.reload(); }

    // === 2. LOGIC ===
    async function startApp() {
        // Zuerst Archiv laden
        await loadGitHubArchive();
        // Dann Live schalten
        connectNtfy();
    }

    async function loadGitHubArchive() {
        log("Lade GitHub Archiv...");
        try {
            const url = `https://api.github.com/repos/${config.ghUser}/${config.ghRepo}/contents/messages.json`;
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${config.ghToken}`, 'Accept': 'application/vnd.github.v3.raw' }});
            
            if(resp.ok) {
                const archiveData = await resp.json();
                log(`${archiveData.length} Nachrichten im Archiv.`);
                for(let item of archiveData) {
                    await processAndAdd({
                        ts: item.timestamp,
                        enc: item.enc,
                        img: item.img 
                    });
                }
            } else { log("Archiv noch leer/nicht gefunden."); }
        } catch(e) { log("GitHub Fehler: " + e.message); }
    }

    function connectNtfy() {
        log(`Live: ${config.ntfyTopic}`);
        const es = new EventSource(`https://ntfy.sh/${config.ntfyTopic}/sse?since=all`);
        
        es.onopen = () => document.getElementById('statusLight').style.background = '#4cd137';
        es.onerror = () => document.getElementById('statusLight').style.background = 'red';

        es.onmessage = async (e) => {
            const data = JSON.parse(e.data);
            if (data.event === 'message') {
                let encPayload = data.attachment ? data.title : data.message;
                let imgData = data.attachment ? data.attachment.url : null;

                await processAndAdd({
                    ts: data.time,
                    enc: encPayload,
                    img: imgData
                });
            }
        };
    }

    async function processAndAdd(item) {
        if(!item.enc) return;
        if (messages.some(m => m.timestamp === item.ts)) return; // Dubletten Check

        let plain = { sender: '?', text: 'Fehler', image: null };
        const jsonStr = await decryptStr(item.enc, config.pass);
        
        if(jsonStr) {
            try {
                const content = JSON.parse(jsonStr);
                plain.sender = content.sender;
                plain.text = content.text;
                // Prio: Wenn im JSON vom Sender ein Bild war (theoretisch) oder im Item (vom GitHub Worker Base64 oder Ntfy URL)
                plain.image = item.img; 
            } catch(e) { plain.text = jsonStr; }
        } else { return; }

        messages.push({
            timestamp: item.ts,
            sender: plain.sender,
            text: plain.text,
            image: plain.image
        });

        messages.sort((a,b) => a.timestamp - b.timestamp);
        
        // Auto-Forward: Wenn wir ganz hinten waren, geh auch beim Update nach hinten
        const wasAtEnd = (currentIndex >= messages.length - 2);
        if (wasAtEnd || messages.length === 1) {
            currentIndex = messages.length - 1;
        }
        updateDisplay();
    }

    function updateDisplay() {
        if(messages.length === 0) { document.getElementById('messageText').innerText = "Warte auf Nachrichten..."; return; }
        
        const msg = messages[currentIndex];
        const txtEl = document.getElementById('messageText');
        const imgEl = document.getElementById('messageImg');
        const metaEl = document.getElementById('metaInfo');

        txtEl.innerText = msg.text || "";
        
        if(msg.image) {
            imgEl.src = msg.image; imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }

        const date = new Date(msg.timestamp * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
        metaEl.innerText = `${msg.sender} • ${date} (${currentIndex + 1}/${messages.length})`;
    }

    window.nextMsg = function() { if(currentIndex < messages.length - 1) { currentIndex++; updateDisplay(); } };
    window.prevMsg = function() { if(currentIndex > 0) { currentIndex--; updateDisplay(); } };
    document.addEventListener('keydown', (e) => { if(e.key === 'ArrowLeft') prevMsg(); if(e.key === 'ArrowRight') nextMsg(); });

    if(!window.isSecureContext) alert("HTTPS erforderlich!");
</script>
</body>
</html>
